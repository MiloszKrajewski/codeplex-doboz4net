<?xml version="1.0" encoding="utf-8" ?>
<rx>
	<macro name="ident" text="[a-zA-Z0-9_]+"/>
	<macro name="esc"><text><![CDATA[(\\x[0-9a-fA-F]{2})|(\\u[0-9a-fA-F]{4})|(\\[^xu])]]></text></macro>
	<macro name="string"><text><![CDATA["(([^"\\])|($(esc)))*"]]></text></macro>
	<macro name="char"><text><![CDATA['(([^'\\])|($(esc)))']]></text></macro>
	
	<macro name="rbracket"><text><![CDATA[\((?<rexpr>(?>\((?<RDEPTH>)|\)(?<-RDEPTH>)|[^()]?)*(?(RDEPTH)(?!)))\)]]></text></macro>
	<macro name="qbracket"><text><![CDATA[\[(?<qexpr>(?>\[(?<QDEPTH>)|\](?<-QDEPTH>)|[^\[\]]?)*(?(QDEPTH)(?!)))\]]]></text></macro>
	<macro name="tbracket"><text><![CDATA[\<(?<texpr>(?>\<(?<RDEPTH>)|\>(?<-RDEPTH>)|[^<>]?)*(?(RDEPTH)(?!)))\>]]></text></macro>
	
	<macro name="type" text="byte|sbyte|int|uint|short|ushort|long|ulong|char"/>
	
	<replace rx="true"  with="$(name)*" rerun="false">
		<text><![CDATA[(const\s+)?(?<name>$(type))\s*\*(\s+const)?]]></text>
	</replace>
	
	<replace rx="true">
		<text><![CDATA[(reinterpret_cast|static_cast)\s*$(tbracket)\s*$(rbracket)]]></text>
		<with>(($(texpr))($(rexpr)))</with>
	</replace>

	<!--
	<replace rx="true">
		<text><![CDATA[static_cast<(?<name>$(ident))>]]></text>
		<with>($(name))</with>
	</replace>
	-->

	<replace rx="true" text="for\s*\(\s*;\s*;\s*\)" with="while (true)"/>
	<replace rx="true" text="while\s*\(\s*1\s*\)" with="while (true)"/>
	
	<!-- trailing spaces -->
	<replace rx="true" rerun="true">
		<text><![CDATA[[\x20\t]*(?<eol>\r?\n)]]></text>
		<with escaped="true">\r\n</with>
	</replace>
	
	<!-- multiple line breaks -->
	<replace rx="true" rerun="true">
		<text><![CDATA[(?<eol>\r?\n\r?\n)(\r?\n)+]]></text>
		<with escaped="true">\r\n\r\n</with>
	</replace>

    <!-- empty braces -->
	<replace rx="true">
		<text>\{\s*\}</text>
		<with>{ /* do nothing */ }</with>
	</replace>
	
	<replace rx="true">
		<text><![CDATA[Peek4\(_,\s*(?<i1>(?<prefix>xxx|src|dst)_$(ident).*?)\)]]></text>
		<with><![CDATA[Peek4($(prefix), $(i1))]]></with>
	</replace>
	
	<replace rx="true">
		<text><![CDATA[\*(?<name>(?<prefix>(xxx|dst|src))_($(ident))(\+\+|\-\-))]]></text>
		<with><![CDATA[$(prefix)[$(name)]]]></with>
	</replace>

	<replace rx="true">
		<text><![CDATA[dst_p\[(?<i1>\d+)\]\s*=\s*xxx_ref\[(?<i2>\d+)\];]]></text>
		<with><![CDATA[dst[dst_p + $(i1)] = dst[dst_ref + $(i2)];]]></with>
	</replace>
</rx>